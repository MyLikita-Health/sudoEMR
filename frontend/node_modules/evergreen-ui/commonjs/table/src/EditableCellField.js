"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _textarea = require("../../textarea");

var EditableCellField =
/*#__PURE__*/
function (_React$PureComponent) {
  (0, _inherits2.default)(EditableCellField, _React$PureComponent);

  function EditableCellField() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2.default)(this, EditableCellField);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2.default)(this, (_getPrototypeOf2 = (0, _getPrototypeOf3.default)(EditableCellField)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "state", {
      top: 0,
      left: 0,
      height: 0,
      width: 0
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "getTableBodyRef", function (targetRef) {
      if (_this.tableBodyRef) return _this.tableBodyRef;
      var ref = targetRef;

      while (ref) {
        var isTableBody = ref.hasAttribute('data-evergreen-table-body');

        if (isTableBody) {
          return ref;
        }

        if (ref.parentElement) {
          ref = ref.parentElement;
        } else {
          return null;
        }
      }

      _this.tableBodyRef = ref;
      return _this.tableBodyRef;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "update", function () {
      var getTargetRef = _this.props.getTargetRef;
      var targetRef = getTargetRef();
      if (!targetRef) return;

      var tableBodyRef = _this.getTableBodyRef(targetRef);

      var _targetRef$getBoundin = targetRef.getBoundingClientRect(),
          left = _targetRef$getBoundin.left,
          targetTop = _targetRef$getBoundin.top,
          height = _targetRef$getBoundin.height,
          width = _targetRef$getBoundin.width;

      var top;

      if (tableBodyRef) {
        var bounds = tableBodyRef.getBoundingClientRect();
        top = Math.min(Math.max(targetTop, bounds.top), bounds.bottom - height);
      } else {
        top = targetTop;
      }

      _this.setState(function () {
        return {
          left: left,
          top: top,
          height: height,
          width: width
        };
      }, function () {
        _this.latestAnimationFrame = requestAnimationFrame(function () {
          _this.update();
        });
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onRef", function (ref) {
      _this.textareaRef = ref;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleBlur", function () {
      if (_this.textareaRef) _this.props.onChangeComplete(_this.textareaRef.value);
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleKeyDown", function (e) {
      var key = e.key;

      if (key === 'Escape') {
        _this.props.onCancel();
      } else if (key === 'Enter') {
        _this.textareaRef.blur();

        e.preventDefault();
      }
    });
    return _this;
  }

  (0, _createClass2.default)(EditableCellField, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this2 = this;

      this.update();
      requestAnimationFrame(function () {
        _this2.textareaRef.focus();
      });
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      cancelAnimationFrame(this.latestAnimationFrame);
      this.props.onCancel();
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props = this.props,
          size = _this$props.size,
          value = _this$props.value,
          minWidth = _this$props.minWidth,
          minHeight = _this$props.minHeight,
          zIndex = _this$props.zIndex;
      var _this$state = this.state,
          left = _this$state.left,
          top = _this$state.top,
          height = _this$state.height,
          width = _this$state.width;
      return _react.default.createElement(_textarea.Textarea, {
        innerRef: this.onRef,
        onKeyDown: this.handleKeyDown,
        onBlur: this.handleBlur,
        appearance: "editable-cell",
        size: size,
        style: {
          left: left,
          top: top,
          height: height,
          minHeight: Math.max(height, minHeight),
          width: width,
          minWidth: Math.max(width, minWidth),
          zIndex: zIndex
        },
        height: null,
        width: null,
        minHeight: null,
        position: "fixed",
        defaultValue: value
      });
    }
  }]);
  return EditableCellField;
}(_react.default.PureComponent);

exports.default = EditableCellField;
EditableCellField.displayName = "EditableCellField";
(0, _defineProperty2.default)(EditableCellField, "propTypes", {
  /**
   * Used as the defaultValue of the textarea.
   */
  value: _propTypes.default.string.isRequired,

  /**
   * The z-index placed on the element.
   */
  zIndex: _propTypes.default.number.isRequired,

  /**
   * Function to get the target ref of the parent.
   * Used to mirror the position.
   */
  getTargetRef: _propTypes.default.func.isRequired,

  /**
   * Min width of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minWidth: _propTypes.default.number.isRequired,

  /**
   * Min height of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minHeight: _propTypes.default.number.isRequired,

  /**
   * Called when the textarea is blurred, pass the value back to the cell.
   */
  onChangeComplete: _propTypes.default.func.isRequired,

  /**
   * Called when Escape is hit or componentWillUnmount.
   */
  onCancel: _propTypes.default.func.isRequired,

  /**
   * Text size of the textarea.
   */
  size: _propTypes.default.number
});
(0, _defineProperty2.default)(EditableCellField, "defaultProps", {
  minWidth: 80,
  minHeight: 40
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvRWRpdGFibGVDZWxsRmllbGQuanMiXSwibmFtZXMiOlsiRWRpdGFibGVDZWxsRmllbGQiLCJ0b3AiLCJsZWZ0IiwiaGVpZ2h0Iiwid2lkdGgiLCJ0YXJnZXRSZWYiLCJ0YWJsZUJvZHlSZWYiLCJyZWYiLCJpc1RhYmxlQm9keSIsImhhc0F0dHJpYnV0ZSIsInBhcmVudEVsZW1lbnQiLCJnZXRUYXJnZXRSZWYiLCJwcm9wcyIsImdldFRhYmxlQm9keVJlZiIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInRhcmdldFRvcCIsImJvdW5kcyIsIk1hdGgiLCJtaW4iLCJtYXgiLCJib3R0b20iLCJzZXRTdGF0ZSIsImxhdGVzdEFuaW1hdGlvbkZyYW1lIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwidXBkYXRlIiwidGV4dGFyZWFSZWYiLCJvbkNoYW5nZUNvbXBsZXRlIiwidmFsdWUiLCJlIiwia2V5Iiwib25DYW5jZWwiLCJibHVyIiwicHJldmVudERlZmF1bHQiLCJmb2N1cyIsImNhbmNlbEFuaW1hdGlvbkZyYW1lIiwic2l6ZSIsIm1pbldpZHRoIiwibWluSGVpZ2h0IiwiekluZGV4Iiwic3RhdGUiLCJvblJlZiIsImhhbmRsZUtleURvd24iLCJoYW5kbGVCbHVyIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwic3RyaW5nIiwiaXNSZXF1aXJlZCIsIm51bWJlciIsImZ1bmMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0lBRXFCQSxpQjs7Ozs7Ozs7Ozs7Ozs7Ozs7OEhBbURYO0FBQ05DLE1BQUFBLEdBQUcsRUFBRSxDQURDO0FBRU5DLE1BQUFBLElBQUksRUFBRSxDQUZBO0FBR05DLE1BQUFBLE1BQU0sRUFBRSxDQUhGO0FBSU5DLE1BQUFBLEtBQUssRUFBRTtBQUpELEs7d0lBb0JVLFVBQUFDLFNBQVMsRUFBSTtBQUM3QixVQUFJLE1BQUtD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a0JFLFFBQUEsUUFBUSxFQUFDLE9BbEJYO0FBbUJFLFFBQUEsWUFBWSxFQUFFWDtBQW5CaEIsUUFERjtBQXVCRDs7O0VBOUs0Q2dCLGVBQU1DLGE7OztBQUFoQzVDLGlCOzhCQUFBQSxpQixlQUNBO0FBQ2pCOzs7QUFHQTJCLEVBQUFBLEtBQUssRUFBRWtCLG1CQUFVQyxNQUFWLENBQWlCQyxVQUpQOztBQU1qQjs7O0FBR0FULEVBQUFBLE1BQU0sRUFBRU8sbUJBQVVHLE1BQVYsQ0FBaUJELFVBVFI7O0FBV2pCOzs7O0FBSUFwQyxFQUFBQSxZQUFZLEVBQUVrQyxtQkFBVUksSUFBVixDQUFlRixVQWZaOztBQWlCakI7Ozs7QUFJQVgsRUFBQUEsUUFBUSxFQUFFUyxtQkFBVUcsTUFBVixDQUFpQkQsVUFyQlY7O0FBdUJqQjs7OztBQUlBVixFQUFBQSxTQUFTLEVBQUVRLG1CQUFVRyxNQUFWLENBQWlCRCxVQTNCWDs7QUE2QmpCOzs7QUFHQXJCLEVBQUFBLGdCQUFnQixFQUFFbUIsbUJBQVVJLElBQVYsQ0FBZUYsVUFoQ2hCOztBQWtDakI7OztBQUdBakIsRUFBQUEsUUFBUSxFQUFFZSxtQkFBVUksSUFBVixDQUFlRixVQXJDUjs7QUF1Q2pCOzs7QUFHQVosRUFBQUEsSUFBSSxFQUFFVSxtQkFBVUc7QUExQ0MsQzs4QkFEQWhELGlCLGtCQThDRztBQUNwQm9DLEVBQUFBLFFBQVEsRUFBRSxFQURVO0FBRXBCQyxFQUFBQSxTQUFTLEVBQUU7QUFGUyxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IHsgVGV4dGFyZWEgfSBmcm9tICcuLi8uLi90ZXh0YXJlYSdcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRWRpdGFibGVDZWxsRmllbGQgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvKipcbiAgICAgKiBVc2VkIGFzIHRoZSBkZWZhdWx0VmFsdWUgb2YgdGhlIHRleHRhcmVhLlxuICAgICAqL1xuICAgIHZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgei1pbmRleCBwbGFjZWQgb24gdGhlIGVsZW1lbnQuXG4gICAgICovXG4gICAgekluZGV4OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBGdW5jdGlvbiB0byBnZXQgdGhlIHRhcmdldCByZWYgb2YgdGhlIHBhcmVudC5cbiAgICAgKiBVc2VkIHRvIG1pcnJvciB0aGUgcG9zaXRpb24uXG4gICAgICovXG4gICAgZ2V0VGFyZ2V0UmVmOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogTWluIHdpZHRoIG9mIHRoZSB0ZXh0YXJlYS5cbiAgICAgKiBUaGUgdGV4dGFyZWEgY2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgY2VsbC5cbiAgICAgKi9cbiAgICBtaW5XaWR0aDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogTWluIGhlaWdodCBvZiB0aGUgdGV4dGFyZWEuXG4gICAgICogVGhlIHRleHRhcmVhIGNhbiBuZXZlciBiZSBzbWFsbGVyIHRoYW4gdGhlIGNlbGwuXG4gICAgICovXG4gICAgbWluSGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBDYWxsZWQgd2hlbiB0aGUgdGV4dGFyZWEgaXMgYmx1cnJlZCwgcGFzcyB0aGUgdmFsdWUgYmFjayB0byB0aGUgY2VsbC5cbiAgICAgKi9cbiAgICBvbkNoYW5nZUNvbXBsZXRlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGVkIHdoZW4gRXNjYXBlIGlzIGhpdCBvciBjb21wb25lbnRXaWxsVW5tb3VudC5cbiAgICAgKi9cbiAgICBvbkNhbmNlbDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFRleHQgc2l6ZSBvZiB0aGUgdGV4dGFyZWEuXG4gICAgICovXG4gICAgc2l6ZTogUHJvcFR5cGVzLm51bWJlclxuICB9XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBtaW5XaWR0aDogODAsXG4gICAgbWluSGVpZ2h0OiA0MFxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgdG9wOiAwLFxuICAgIGxlZnQ6IDAsXG4gICAgaGVpZ2h0OiAwLFxuICAgIHdpZHRoOiAwXG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLnVwZGF0ZSgpXG5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgdGhpcy50ZXh0YXJlYVJlZi5mb2N1cygpXG4gICAgfSlcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMubGF0ZXN0QW5pbWF0aW9uRnJhbWUpXG4gICAgdGhpcy5wcm9wcy5vbkNhbmNlbCgpXG4gIH1cblxuICBnZXRUYWJsZUJvZHlSZWYgPSB0YXJnZXRSZWYgPT4ge1xuICAgIGlmICh0aGlzLnRhYmxlQm9keVJlZikgcmV0dXJuIHRoaXMudGFibGVCb2R5UmVmXG5cbiAgICBsZXQgcmVmID0gdGFyZ2V0UmVmXG4gICAgd2hpbGUgKHJlZikge1xuICAgICAgY29uc3QgaXNUYWJsZUJvZHkgPSByZWYuaGFzQXR0cmlidXRlKCdkYXRhLWV2ZXJncmVlbi10YWJsZS1ib2R5JylcbiAgICAgIGlmIChpc1RhYmxlQm9keSkge1xuICAgICAgICByZXR1cm4gcmVmXG4gICAgICB9XG4gICAgICBpZiAocmVmLnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgcmVmID0gcmVmLnBhcmVudEVsZW1lbnRcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy50YWJsZUJvZHlSZWYgPSByZWZcbiAgICByZXR1cm4gdGhpcy50YWJsZUJvZHlSZWZcbiAgfVxuXG4gIHVwZGF0ZSA9ICgpID0+IHtcbiAgICBjb25zdCB7IGdldFRhcmdldFJlZiB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IHRhcmdldFJlZiA9IGdldFRhcmdldFJlZigpXG4gICAgaWYgKCF0YXJnZXRSZWYpIHJldHVyblxuICAgIGNvbnN0IHRhYmxlQm9keVJlZiA9IHRoaXMuZ2V0VGFibGVCb2R5UmVmKHRhcmdldFJlZilcblxuICAgIGNvbnN0IHtcbiAgICAgIGxlZnQsXG4gICAgICB0b3A6IHRhcmdldFRvcCxcbiAgICAgIGhlaWdodCxcbiAgICAgIHdpZHRoXG4gICAgfSA9IHRhcmdldFJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gICAgbGV0IHRvcFxuICAgIGlmICh0YWJsZUJvZHlSZWYpIHtcbiAgICAgIGNvbnN0IGJvdW5kcyA9IHRhYmxlQm9keVJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICAgdG9wID0gTWF0aC5taW4oTWF0aC5tYXgodGFyZ2V0VG9wLCBib3VuZHMudG9wKSwgYm91bmRzLmJvdHRvbSAtIGhlaWdodClcbiAgICB9IGVsc2Uge1xuICAgICAgdG9wID0gdGFyZ2V0VG9wXG4gICAgfVxuXG4gICAgdGhpcy5zZXRTdGF0ZShcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBsZWZ0LFxuICAgICAgICAgIHRvcCxcbiAgICAgICAgICBoZWlnaHQsXG4gICAgICAgICAgd2lkdGhcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy5sYXRlc3RBbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy51cGRhdGUoKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIG9uUmVmID0gcmVmID0+IHtcbiAgICB0aGlzLnRleHRhcmVhUmVmID0gcmVmXG4gIH1cblxuICBoYW5kbGVCbHVyID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnRleHRhcmVhUmVmKSB0aGlzLnByb3BzLm9uQ2hhbmdlQ29tcGxldGUodGhpcy50ZXh0YXJlYVJlZi52YWx1ZSlcbiAgfVxuXG4gIGhhbmRsZUtleURvd24gPSBlID0+IHtcbiAgICBjb25zdCB7IGtleSB9ID0gZVxuICAgIGlmIChrZXkgPT09ICdFc2NhcGUnKSB7XG4gICAgICB0aGlzLnByb3BzLm9uQ2FuY2VsKClcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ0VudGVyJykge1xuICAgICAgdGhpcy50ZXh0YXJlYVJlZi5ibHVyKClcbiAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgIH1cbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHNpemUsIHZhbHVlLCBtaW5XaWR0aCwgbWluSGVpZ2h0LCB6SW5kZXggfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7IGxlZnQsIHRvcCwgaGVpZ2h0LCB3aWR0aCB9ID0gdGhpcy5zdGF0ZVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxUZXh0YXJlYVxuICAgICAgICBpbm5lclJlZj17dGhpcy5vblJlZn1cbiAgICAgICAgb25LZXlEb3duPXt0aGlzLmhhbmRsZUtleURvd259XG4gICAgICAgIG9uQmx1cj17dGhpcy5oYW5kbGVCbHVyfVxuICAgICAgICBhcHBlYXJhbmNlPVwiZWRpdGFibGUtY2VsbFwiXG4gICAgICAgIHNpemU9e3NpemV9XG4gICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgbGVmdCxcbiAgICAgICAgICB0b3AsXG4gICAgICAgICAgaGVpZ2h0LFxuICAgICAgICAgIG1pbkhlaWdodDogTWF0aC5tYXgoaGVpZ2h0LCBtaW5IZWlnaHQpLFxuICAgICAgICAgIHdpZHRoLFxuICAgICAgICAgIG1pbldpZHRoOiBNYXRoLm1heCh3aWR0aCwgbWluV2lkdGgpLFxuICAgICAgICAgIHpJbmRleFxuICAgICAgICB9fVxuICAgICAgICBoZWlnaHQ9e251bGx9XG4gICAgICAgIHdpZHRoPXtudWxsfVxuICAgICAgICBtaW5IZWlnaHQ9e251bGx9XG4gICAgICAgIHBvc2l0aW9uPVwiZml4ZWRcIlxuICAgICAgICBkZWZhdWx0VmFsdWU9e3ZhbHVlfVxuICAgICAgLz5cbiAgICApXG4gIH1cbn1cbiJdfQ==